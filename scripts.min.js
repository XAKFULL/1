$(document).ready(function(){
	(function () {
		if (typeof IexForms === 'undefined') return;

		let $messageButton = $('.js-pform-show[data-pform-id="manager-popup"]'); // показываем через 10сек и скрываем после отправки формы
		setTimeout(function () {
			$messageButton.addClass('active');
		}, 15000);

		let cbConsult = {
			'onHide': function (form) {
				$messageButton.removeClass('active');
			},
			'onSuccess': function (form) {
				$messageButton.removeClass('active');
			}
		};

		let formsParams = {
			'manager-popup': { config: '/libs/iex10/iexform/index.php?config=onestep&template=mnager-popup', callback: cbConsult },
			'callback-popup': { config: '/libs/iex10/iexform/index.php?config=onestep&template=name-phone' },
			'product': { config: '/libs/iex10/iexform/index.php?config=onestep&template=threeprot' },
			'footer': { config: '/libs/iex10/iexform/index.php?config=onestep&template=footer' },
			'calc': { config: '/libs/iex10/iexform/index.php?config=multistep&template=calc' },
		};

		window.iexForms = new IexForms(formsParams);
	})();
})

$(function () {
	/**
    * Инициализация скриптов
    */
	var relizeScript = {
		// Функиця запуска основных инициализаций
		start: function () {
			this.isMobile();
			this.svgLoad();
			this.documentBind();
			var scrollPos = $(window).scrollTop()
			relizeScript.loadAnimate(scrollPos)
		},
		// Проверка на мобильный
		// Если true запускает слайдер "команда"
		isMobile: function () {
			if ($(window).width() < 575) {
				this.mobileSlider();
				return true;
			}
		},
		// Проверка на таблеты
		// Если true запускает слайдер "работы"
		isTabs: function () {
			if ($(window).width() < 992) {
				this.activateSlider();
				return true;
			}
		},
		// Запуск слайдера работ
		activateSlider: function () {
			$('.workSlider').slick({
				infinite: true,
				slidesToShow: 1,
				slidesToScroll: 1
			});
		},
		// Ребилд svg из img в <svg>
		svgLoad: function () {
			$('img.svg').each(function () {
				var img = $(this);
				var imgID = img.attr('id');
				var imgClass = img.attr('class');
				var imgURL = img.attr('src');

				jQuery.get(imgURL, function (data) {
					var svg = $(data).find('svg');

					if (typeof imgID !== 'undefined') {
						svg = svg.attr('id', imgID);
					}

					if (typeof imgClass !== 'undefined') {
						svg = svg.attr('class', imgClass + ' replaced-svg');
					}

					svg = svg.removeAttr('xmlns:a');
					img.replaceWith(svg);

				}, 'xml');

			});
		},
		// Анимация при скролле
		loadAnimate: function (scrolledTo) {
			var a = $('.js-scroll')
			var h = $(window).height()
			var thr = parseInt(h * 0.5)
			var s = 0
			a.each(function () {
				var block = $(this),
					blockHeight = block.outerHeight(),
					blockPos = block.offset().top - s;
				if (scrolledTo + h - thr > blockPos - s) {
					if (!block.hasClass('animate-in')) {
						block.addClass('animate-in');
					}
				}
			});
		},
		lazyLoad: function (scrolledTo) {
			if ($('.card-image').hasClass('is-loaded')) {
				return
			}
			var a = $('.teamList')
			var h = $(window).height()
			var thr = parseInt(h * 0.5)
			var s = 0
			a.each(function () {
				var block = $(this),
					blockPos = block.offset().top - s;
				if (scrolledTo + h - thr > blockPos - s) {
					var card_images = document.querySelectorAll('.card-image');

					card_images.forEach(function (card_image) {
						var image_url = card_image.getAttribute('data-image-full');
						var content_image = card_image.querySelector('img');

						content_image.src = image_url;

						content_image.addEventListener('load', function () {
							card_image.style.backgroundImage = 'url(' + image_url + ')';
							card_image.className = card_image.className + ' is-loaded';
						});

					});

				}
			});
		},
		// Запуск слайдера "команда"
		mobileSlider: function () {
			$('.teamList').slick({
				infinite: true,
				slidesToShow: 1,
				slidesToScroll: 1
			});
		},
		setMenu: function (p) {
			var a = $('.slide_to');
			a.each(function () {
				var at = $(this),
					ath = at.attr('href'),
					s = $('.section-id');
				s.each(function () {
					var ts = $(this),
						tsi = ts.attr('id');
					if (p + 100 > ts.offset().top) {
						a.removeClass('active');
						$('.slide_to[href="#' + tsi + '"]').addClass('active')
					}
				})
			})
		},
		documentBind: function () {

			// Аккордеон списка услуг
			$('.priceTab__more__link').bind('click', function () {
				$('.priceTab').addClass('show');
			});

			$('.moreWorks').bind('click', function () {
				$('.workSlider__item.hidden').removeClass('hidden');
				$('.moreWorks').addClass('d-none')
			})

			$('.priceTab__more__link--hide').bind('click', function () {
				$('.priceTab').removeClass('show');
			});

			// Скрол по якорям
			$('.slide_to').bind('click', function (e) {
				e.preventDefault();
				$('.modalMenu').removeClass('is-opened');

				var i = $(this).attr('href');
				var t = $(i).offset().top;

				TweenMax.killTweensOf(window),
					TweenMax.to(window, 1, {
						scrollTo: {
							y: t,
							autoKill: !1
						},
						ease: Circ.easeInOut
					}),
					1000
			});

			// Табы цикла продукта
			$('.projMove').bind('click', function () {
				var data = $(this).attr('data-id');
				$('.projMove.active').removeClass('active');
				$('.projMove[data-id="' + data + '"]').addClass('active');
				$('.projSlider__item.active').removeClass('active');
				$('.projSlider__item[data-id="' + data + '"]').addClass('active');
			});

			// Табы цен на мобильных
			$(".priceTabs__nav__item").bind("click", function () {
				$(this).addClass("active").siblings().removeClass("active"),
					$(".priceTabs").removeClass("active").eq($(this).index()).addClass("active")
			});

			// Бинды для скрола
			$(window).bind('scroll', function (e) {
				var p = $(window).scrollTop()
				relizeScript.loadAnimate(p)
				relizeScript.lazyLoad(p)
				relizeScript.setMenu(p)
			});

			// Фулл-сайз меню
			$('.hamburger').bind('click', function (e) {
				e.preventDefault();
				$('.modalMenu').toggleClass('is-opened');
			});

		}
	};
	// Запуск js
	relizeScript.start();

});